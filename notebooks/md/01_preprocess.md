# ConveyorGuard 전처리 설계 및 결과

## 1. 왜 "윈도우 단위"로 잘랐나?

### EDA에서 발견한 문제
- 심각(3)이 "dominant"인 세션 = **0개**
- 심각 구간 "포함" 세션 = **289개**
- → 세션 전체로 보면 심각이 묻혀버림!

### 비유
> 1시간짜리 영화에서 무서운 장면이 5분만 나옴
> - 영화 전체 = "로맨스" (dominant)
> - 5분 구간 = "공포" (심각)

### 해결
30프레임씩 잘라서 그 구간의 상태를 판단

```
[정상 정상 정상 ... 경미 경미 ... 중간 중간 ... 심각 심각]
      ↓ 30프레임 윈도우로 자르기
[윈도우1: 정상] [윈도우2: 경미] [윈도우3: 중간] [윈도우4: 심각] ✅
```

### 결과
- 심각 윈도우 **577개** 확보!
- 세션 단위였으면 **0개**였음

---

## 2. 왜 "세션 단위 Split"을 했나?

### ❌ 잘못된 Split (프레임/윈도우 단위)
```
세션A: [윈도우1] [윈도우2] [윈도우3] [윈도우4]
           ↓         ↓         ↓         ↓
        Train     Train      Test      Test
```
**문제**: 같은 세션의 윈도우가 train/test에 섞임  
→ 모델이 "이미 본" 패턴으로 테스트 = **성능 뻥튀기**

### ✅ 올바른 Split (세션 단위)
```
세션A: [윈도우1] [윈도우2] [윈도우3] [윈도우4] → 전부 Train
세션B: [윈도우1] [윈도우2] [윈도우3]           → 전부 Test
```
→ 모델이 "처음 보는" 세션으로 테스트 = **진짜 성능**

### 결과
- 세션 누출 검증 **통과** ✅
- Train/Val/Test 세션 겹침 **0개**

---

## 3. 왜 "클래스 가중치"를 줬나?

### 데이터 불균형
| 클래스 | 개수 | 문제 |
|--------|------|------|
| 정상 | 3,586개 | 많음 |
| 심각 | 401개 | 적음 (9배 차이!) |

**문제**: 모델이 "다 정상이라고 하면 90% 맞음" 전략 사용  
→ 심각을 **절대 못 잡음**

### 해결: 적은 클래스에 높은 가중치
| 클래스 | 가중치 | 의미 |
|--------|--------|------|
| 정상(0) | 0.28 | 틀려도 페널티 낮음 |
| 경미(1) | 0.60 | - |
| 중간(2) | 0.61 | - |
| 심각(3) | **2.51** | 틀리면 페널티 9배! |

### 비유
> 시험에서 쉬운 문제 1점, 어려운 문제 9점

---

## 4. 최종 데이터셋

### Split 구성 (70/15/15)
| Split | 윈도우 | 세션 | 비율 |
|-------|--------|------|------|
| Train | 7,311 | 238 | 70% |
| Val | 1,554 | 51 | 15% |
| Test | 1,608 | 52 | 15% |

### 클래스별 분포
| 클래스 | Train | Val | Test |
|--------|-------|-----|------|
| 정상(0) | 3,586 | 732 | 788 |
| 경미(1) | 1,682 | 367 | 371 |
| 중간(2) | 1,642 | 367 | 361 |
| 심각(3) | 401 | 88 | 88 |

### 데이터 Shape
- `sensors`: (N, 30, 8) — 센서 8채널 × 30프레임
- `images`: (N, 30, 60, 80) — 열화상 60×80 × 30프레임
- `external`: (N, 30, 3) — 외부환경 3채널 × 30프레임
- `labels`: (N,) — 4-class (0~3)

---

## 5. 핵심 설계 요약

| 설계 | 왜? | 효과 |
|------|-----|------|
| 윈도우 단위 (30프레임) | 심각이 구간에서만 발생 | 심각 샘플 확보 |
| 세션 단위 Split | 데이터 누출 방지 | 진짜 성능 측정 |
| 클래스 가중치 | 불균형 대응 (6.34:1) | 심각 탐지 강화 |
| EDA 기반 정규화 | 하드코딩 제거 | 데이터 기반 전처리 |

---

## 6. 파이프라인 연결

```
00_EDA
  ├── 클래스 분포 분석 → 윈도우 필요성 발견
  ├── 센서 상관도 → 정규화 범위 결정
  └── 심각(3) 특성 → 윈도우 크기 결정
        ↓
01_preprocess (현재)
  ├── 윈도우 생성 (30프레임, stride 10)
  ├── 세션 단위 Split
  └── 클래스 가중치 계산
        ↓
02_baseline_cnn / 03_dl_fusion
  └── class_weights 적용하여 학습
```
